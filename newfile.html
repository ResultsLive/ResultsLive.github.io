<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="bootstrap.min.css" rel="stylesheet">
    <title>Track & Field Fixtures</title>
    <link rel="icon" href="favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="Icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="Icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="Icons/favicon-16x16.png">
    <link rel="manifest" href="Icons/site.webmanifest">

    <style>
        /* Page background */
        body {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            font-family: "Segoe UI", Roboto, sans-serif;
        }

        /* Card container */
        .accordion-container {
            background: #fff;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            width: 100%;
            max-width: 700px;
        }

        .accordion-collapse {
            transition: height 0.6s cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        .accordion-button:hover {
            background-color: #f1f3f5;
        }

        .accordion-button:focus {
            box-shadow: none;
        }

        .accordion-item {
            border-radius: 0.5rem;
            overflow: hidden;
            margin-bottom: 0.75rem;
            border: 1px solid #dee2e6 !important;
        }

        /* LIVE badge */
        .live-badge {
            display: inline-block;
            background: #dc3545;
            color: #fff;
            font-size: 0.65rem;
            font-weight: 600;
            padding: 0.15rem 0.4rem;
            border-radius: 0.35rem;
            margin-left: 0.4rem;
            vertical-align: middle;
            box-shadow: 0 0 6px rgba(220, 53, 69, 0.5);
        }

        /* Fade out past matches */
        .past-match {
            opacity: 0.45;
            filter: grayscale(60%);
        }

        .accordion-button .live-badge {
            line-height: 1.5;
        }
    </style>
</head>

<body>

    <div class="accordion-container">

        <h2 class="mb-4 text-center fw-bold">Track & Field Results</h2>

        <div class="accordion" id="accordionExample">

            <!-- Wessex League -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingWessex25">
                    <button class="accordion-button collapsed"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapseWessex25"
                            aria-expanded="false"
                            aria-controls="collapseWessex25">
                        Wessex Track and Field League — 2025
                    </button>

                </h2>
                <div id="collapseWessex25"
                     class="accordion-collapse collapse"
                     aria-labelledby="headingWessex25">
                    <div class="accordion-body">
                        <ul class="mb-0" id="wessex-results-list25"></ul>
                    </div>
                </div>
            </div>

            <div class="accordion-item">
                <h2 class="accordion-header" id="headingWessex26">
                    <button class="accordion-button collapsed"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapseWessex26"
                            aria-expanded="false"
                            aria-controls="collapseWessex26">
                        Wessex Track and Field League — 2026
                    </button>

                </h2>
                <div id="collapseWessex26"
                     class="accordion-collapse collapse"
                     aria-labelledby="headingWessex26">
                    <div class="accordion-body">
                        <ul class="mb-0" id="wessex-results-list26"></ul>
                    </div>
                </div>
            </div>

            <!-- Oxfordshire League -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingOxon25">
                    <button class="accordion-button collapsed"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapseOxon25"
                            aria-expanded="false"
                            aria-controls="collapseOxon25">
                        Oxfordshire Track and Field League — 2025
                    </button>
                </h2>
                <div id="collapseOxon25"
                     class="accordion-collapse collapse"
                     aria-labelledby="headingOxon25">
                    <div class="accordion-body">
                        <ul class="mb-0" id="oxon-results-list25"></ul>
                    </div>
                </div>
            </div>

            <div class="accordion-item">
                <h2 class="accordion-header" id="headingOxon26">
                    <button class="accordion-button collapsed"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapseOxon26"
                            aria-expanded="false"
                            aria-controls="collapseOxon26">
                        Oxfordshire Track and Field League — 2026
                    </button>
                </h2>
                <div id="collapseOxon26"
                     class="accordion-collapse collapse"
                     aria-labelledby="headingOxon26">
                    <div class="accordion-body">
                        <ul class="mb-0" id="oxon-results-list26"></ul>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE_URL = window.location.hostname === ""
            ? "https://localhost:7073" : "https://athleticsresultsapi-drardae4htehawen.ukwest-01.azurewebsites.net";

        const API_ENDPOINTS = {list: `${API_BASE_URL}/listappfolder`};

        const collapseIds = ["collapseOxon25", "collapseOxon26", "collapseWessex25", "collapseWessex26"];

        const collapses = collapseIds.map(id => new bootstrap.Collapse(document.getElementById(id), { toggle: false }));

        function getFiles() {

            fetch(API_ENDPOINTS.list)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    function populateLeagueList(leagueName, yearName, listId) {
                        const league = data.children.find(child => child.name === leagueName);
                        if (!league) return;
                        const year = league.children.find(child => child.name === yearName);
                        if (!year) return;
                        const items = year.children.map(item => ({ name: item.name, id: item.id }));
                        const groupedResults = groupFiles(items);
                        const list = document.getElementById(listId);
                        if (!list) return;
                        list.innerHTML = "";
                        groupedResults.forEach(result => {
                            const li = document.createElement("li");
                            li.setAttribute("data-date", result.date);
                            const a = document.createElement("a");
                            a.href = `index.html?Main=${result.MainID}&QK=${result.QKID}`;
                            a.textContent = result.name;
                            li.appendChild(a);
                            list.appendChild(li);
                        });
                    }
                    populateLeagueList("OTFL", "2025", "oxon-results-list25");
                    populateLeagueList("OTFL", "2026", "oxon-results-list26");
                    populateLeagueList("Wessex", "2025", "wessex-results-list25");
                    populateLeagueList("Wessex", "2026", "wessex-results-list26");

                    Live();
                    collapses.forEach(c => c.show())
                })
                .catch(error => {
                    console.error("Error fetching JSON:", error); // TODO fix this
                });
        }

        function groupFiles(items) {
            // Map: key = matchNumber + date, value = { name, date, MainID, QKID }
            const groups = {};
            items.forEach(item => {
                const name = item.name;
                const id = item.id;
                const match = name.match(/Match_(\d+)/);
                const dateMatch = name.match(/\d{4}-\d{2}-\d{2}/);
                if (!match || !dateMatch) return;
                const matchNumber = match[1];
                const date = dateMatch[0];
                const d = new Date(date);
                const shortDate = d.toLocaleDateString("en-GB", {
                    day: "numeric",
                    month: "long"
                });
                const key = `${matchNumber}_${date}`;
                if (!groups[key]) {
                    groups[key] = {
                        name: `Match ${matchNumber} - ${shortDate}`,
                        date,
                        MainID: null,
                        QKID: null
                    };
                }
                if (/Main/i.test(name)) {
                    groups[key].MainID = id;
                }
                if (/QuadKids/i.test(name)) {
                    groups[key].QKID = id;
                }
            });
            // Return as sorted array of objects
            return Object.values(groups).sort((a, b) => a.date.localeCompare(b.date));
        }

        function Live() {
            const today = new Date().toISOString().split("T")[0]; // "2025-08-17"; - if you want to run a test
            const matches = document.querySelectorAll("li[data-date]");

            matches.forEach(match => {
                const matchDate = match.dataset.date;

                if (matchDate === today) {
                    // LIVE match
                    const badge = document.createElement("span");
                    badge.className = "live-badge";
                    badge.textContent = "LIVE";
                    match.appendChild(badge);

                    // Add LIVE to accordion header
                    const accordionItem = match.closest(".accordion-item");
                    const headerButton = accordionItem.querySelector(".accordion-button");

                    if (!headerButton.querySelector(".live-badge")) {
                        const headerBadge = document.createElement("span");
                        headerBadge.className = "live-badge";
                        headerBadge.textContent = "LIVE";
                        headerButton.appendChild(headerBadge);
                    }

                } else if (matchDate < today) {
                    // Past match → fade it out
                    match.classList.add("past-match");
                }
            });
        };

        document.addEventListener("DOMContentLoaded", () => {
            getFiles();
            setInterval(getFiles, 60 * 60 * 1000);
        });
    </script>
</body>
</html>
